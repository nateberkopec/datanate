<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= @config['dashboard']['title'] %></title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg"/>
    <link rel="stylesheet" href="style.css"/>
    <script src="d3.js"></script>
</head>
<body>
    <div class="header">
        <h1><%= @config['dashboard']['title'] %></h1>
        <p><%= @config['dashboard']['description'] %></p>
    </div>

    <div class="container">
        <% grouped_metrics.each do |category_key, types| %>
        <div class="category-section">
            <div class="category-header">
                <h2 class="category-title" style="color: <%= categories[category_key]['color'] %>">
                    <%= categories[category_key]['name'] %>
                </h2>
                <span class="category-description"><%= categories[category_key]['description'] %></span>
            </div>
            
            <div class="metrics-grid">
                <% types.values.flatten.sort_by { |m| m[:tier] }.each do |metric| %>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-info">
                            <div class="metric-title-row">
                                <h4 class="metric-title"><%= metric[:config]['display_name'] %></h4>
                                <span class="tier-indicator tier-<%= metric[:tier] %>">
                                    Tier <%= metric[:tier] %>
                                </span>
                            </div>
                            <div class="metric-details-row">
                                <% relationships = metric_relationships[metric[:id]] %>
                                <% if relationships && (relationships['influenced_by'] || relationships['influences']) %>
                                <div class="metric-relationships">
                                    <% if relationships['influences'] && !relationships['influences'].empty? %>
                                    <div class="relationship-group">
                                        <span class="relationship-label">Influenced by:</span>
                                        <span class="relationship-links">
                                            <% relationships['influences'].each_with_index do |rel_id, idx| %>
                                                <% rel_metric = @metric_data.find_by_id(rel_id) %>
                                                <% if rel_metric %>
                                                    <a href="#chart-<%= rel_id %>" class="relationship-link"><%= rel_metric[:config]['display_name'] %></a><% if idx < relationships['influences'].length - 1 %>, <% end %>
                                                <% end %>
                                            <% end %>
                                        </span>
                                    </div>
                                    <% end %>
                                    <% if relationships['influenced_by'] && !relationships['influenced_by'].empty? %>
                                    <div class="relationship-group">
                                        <span class="relationship-label">Influences:</span>
                                        <span class="relationship-links">
                                            <% relationships['influenced_by'].each_with_index do |rel_id, idx| %>
                                                <% rel_metric = @metric_data.find_by_id(rel_id) %>
                                                <% if rel_metric %>
                                                    <a href="#chart-<%= rel_id %>" class="relationship-link"><%= rel_metric[:config]['display_name'] %></a><% if idx < relationships['influenced_by'].length - 1 %>, <% end %>
                                                <% end %>
                                            <% end %>
                                        </span>
                                    </div>
                                    <% end %>
                                </div>
                                <% end %>
                                <% if metric[:config]['target'] %>
                                <div class="metric-target">Target: <%= number_with_delimiter(metric[:config]['target']) %></div>
                                <% end %>
                            </div>
                        </div>
                        <div class="metric-value">
                            <%= number_with_delimiter(metric[:latest_value]&.round(1) || 0) %>
                            <span class="metric-unit"><%= metric[:config]['unit'] %></span>
                        </div>
                    </div>
                    <div class="chart-container" id="chart-<%= metric[:id] %>"></div>
                </div>
                <% end %>
            </div>
        </div>
        <% end %>

        <div class="relationships">
            <h2>Metric Relationships</h2>
            <% categories.each do |category_key, category_data| %>
            <div class="category-relationships">
                <h3 style="color: <%= category_data['color'] %>"><%= category_data['name'] %> Dependencies</h3>
                <div id="relationships-chart-<%= category_key %>" class="relationships-chart" style="height: 300px;"></div>
            </div>
            <% end %>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        window.metricsData = <%= generate_js_data %>;
        window.relationships = <%= metric_relationships.to_json %>;
    </script>
    <script src="app.js"></script>
</body>
</html>