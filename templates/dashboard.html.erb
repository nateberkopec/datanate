<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= @config['dashboard']['title'] %></title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg"/>
    <link rel="stylesheet" href="style.css"/>
    <script src="d3.min.js"></script>
</head>
<body>
    <div class="header">
        <h1><%= @config['dashboard']['title'] %></h1>
        <p><%= @config['dashboard']['description'] %></p>
    </div>

    <div class="container">
        <% grouped_metrics.each do |category_key, types| %>
        <div class="category-section">
            <div class="category-header">
                <h2 class="category-title" style="color: <%= categories[category_key]['color'] %>">
                    <%= categories[category_key]['name'] %>
                </h2>
                <span class="category-description"><%= categories[category_key]['description'] %></span>
            </div>
            
            <% types.keys.sort.each do |tier| %>
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">
                            Tier <%= tier %> Metrics
                        </h3>
                        <span class="section-description">
                            <%= case tier
                                when 0
                                  'Base metrics with no dependencies'
                                else
                                  "#{tier} step#{'s' if tier > 1} removed from base metrics"
                                end %>
                        </span>
                    </div>
                    
                    <div class="metrics-grid">
                        <% types[tier].each do |metric| %>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div>
                                    <h4 class="metric-title"><%= metric[:config]['display_name'] %></h4>
                                    <span class="tier-indicator tier-<%= metric[:tier] %>">
                                        Tier <%= metric[:tier] %>
                                    </span>
                                </div>
                                <div class="metric-value">
                                    <%= number_with_delimiter(metric[:latest_value]&.round(1) || 0) %>
                                    <span class="metric-unit"><%= metric[:config]['unit'] %></span>
                                    <% if metric[:config]['target'] %>
                                    <div class="metric-target">Target: <%= number_with_delimiter(metric[:config]['target']) %></div>
                                    <% end %>
                                </div>
                            </div>
                            <div class="chart-container" id="chart-<%= metric[:id] %>"></div>
                        </div>
                        <% end %>
                    </div>
                </div>
            <% end %>
        </div>
        <% end %>

        <div class="relationships">
            <h2>Metric Relationships</h2>
            <div id="relationships-chart" style="height: 400px;"></div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        window.metricsData = <%= generate_js_data %>;
        window.relationships = <%= metric_relationships.to_json %>;
    </script>
    <script src="app.js"></script>
</body>
</html>